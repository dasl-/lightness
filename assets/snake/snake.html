<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/snake/style.css">

    <title>SNAKE</title>



    <script>
      $(document).ready(function () {
        var web_socket = null;
        var last_high_score_id;

        $(".quad").click(function() {
          if (!web_socket) {
            return;
          }
          var direction = $(this).data("direction");
          web_socket.send(direction);
          $(".button").css("background-image", "url('/assets/snake/snake.png')");
          $(".button[data-direction='" + direction + "']").css("background-image", "url('/assets/snake/snake-active.png')");
          console.log(direction);
        });

        $(".new-game").click(function(){
          var difficulty = $("#difficulty").val();
          $.post({
              url: "/api/enqueue_game",
              data: JSON.stringify({
                title: 'snake',
                difficulty: difficulty
              })
          });
          var loc = window.location, new_uri;
          if (loc.protocol === "https:") {
            new_uri = "wss:";
          } else {
            new_uri = "ws:";
          }
          new_uri += "//" + loc.hostname + ":8765/";
          web_socket = new WebSocket(new_uri);
          web_socket.onopen = function(event) {
            console.log("WebSocket is open.");
          };
          web_socket.onclose = function(event) {
            web_socket = null;
            console.log("WebSocket is closed.");
          };

          web_socket.onmessage = function(event) {
            console.log(event.data);
            var message = JSON.parse(event.data);
            if(message.message_type == "high_score") {
              last_high_score_id = message.score_id;
              console.log("Score_Id" + last_high_score_id);
              $(".initialinput").show();
            }
          };

        });


        //Keyboard input
        $(document).keydown(function(e) {
          var keyinput = e.keyCode;
          var direction;
          //Arrow key input
          if (keyinput == 38) { direction = 1; }
          if (keyinput == 40) { direction = 2; }
          if (keyinput == 37) { direction = 3; }
          if (keyinput == 39) { direction = 4; }


          //WASD input

          if (keyinput == 87) { direction = 1; }
          if (keyinput == 83) { direction = 2; }
          if (keyinput == 65) { direction = 3; }
          if (keyinput == 68) { direction = 4; }


          if(direction) {
            web_socket.send(direction);

            //change to pre-loaded images
            $(".button").css("background-image", "url('/assets/snake/snake.png')");
            $(".button[data-direction='" + direction + "']").css("background-image", "url('/assets/snake/snake-active.png')");
          }
        });

        //Menu button for mobile
        $(".menubutton").click(function() {
          $(".menu").slideToggle("fast");
        });

        //Dropdown menu toggle
        $(".dropdown").click(function() {
          $(this).next("ul").toggle("fast","swing");
        });

        //Show/hide leaderboard
        $("#leader").click(function() {
          $(".leaderboard").fadeIn();
        });
        $(document).mouseup(function (e){
          var container = $(".leaderboard");
          if (!container.is(e.target) && container.has(e.target).length === 0){
          container.fadeOut();
        }
        });

        //Lower difficulty if mobile
        var isTouchDevice = 'ontouchstart' in document.documentElement;
        if ( isTouchDevice ) {
        // do mobile handling
          var difficulty = $('#difficulty');
          difficulty.val('3');

          $(".new-game").click(function() {
            $(".menu").hide();
          });

        }

        $('#difficulty').on('input', function() {
          localStorage.setItem('difficulty', this.value);
          document.getElementById('difficultyval').innerHTML = this.value;
        });

        var saved_difficulty = localStorage.getItem('difficulty');
        if (saved_difficulty !== null && parseInt(saved_difficulty) == saved_difficulty && saved_difficulty > 0 && saved_difficulty < 10) {
          $('#difficulty').val(saved_difficulty);
        }

        document.getElementById('difficultyval').innerHTML = document.getElementById('difficulty').value;

        $('#initials-submit').click(function() {
          var initials = $('#initials').val();
          $.post({
              url: "/api/submit_game_score_initials",
              data: JSON.stringify({
                score_id: last_high_score_id,
                initials: initials
              })
          });
        });

      });
    </script>

    <span class="menubutton">Menu</span>

    <nav class="menu">
      <ul>
        <li><a class="new-game">New Game</a></li>
        <li>
          <a class="dropdown">Settings</a>
          <ul>
            <li><label>Difficulty</label>
              <input type="range" min="1" max="9" value="7" class="slider" id="difficulty"><span id="difficultyval"></span>
            </li>
          </ul>
        </li>
        <li><a id="leader">Hi-Score</a></li>
        <li><a href="http://pifi.club">Pi-Fi</a></li>
      </ul>
    </nav>

  </head>
  <body>

    <div class="quad topq" data-direction="1"></div>
    <div class="quad leftq" data-direction="3"></div>
    <div class="quad rightq" data-direction="4"></div>
    <div class="quad bottomq" data-direction="2"></div>

    <div class="leaderboard">
      <ol>
        <li><span class="leaderinitial">DAL</span>.............<span class="leaderscore">0157</span></li>
        <li><span class="leaderinitial">ADL</span>.............<span class="leaderscore">0117</span></li>
      </ol>
    </div>


    <div class="initialinput">
      <form>
        <input id="initials" type="text" name="initials" value="ABC" />
        <input id="initials-submit" type="button" value="Submit">
      </form>
    </div>

    <div class="wrapper">
      <div class="button up" data-direction="1"></div>
      <div class="lrwrapper">
        <div class="button left" data-direction="3"></div>
        <div class="spacer"></div>
        <div class="button right" data-direction="4"></div>
      </div>
      <div class="button down" data-direction="2"></div>

    </div>

  </body>
</html>