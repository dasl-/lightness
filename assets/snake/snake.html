<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/snake/style.css">

    <title>SNAKE</title>



    <script>
      var web_socket = null;
      var last_high_score_id;

      function GetHighScores() {
        $("#leaderrow").html("Loading...");
        $.get({
          url: "/api/get_high_scores",
          data: JSON.stringify({
            game_type: 'snake'
          }),
          success: function(response) {
            console.log(response);
            var high_scores = response.high_scores;
            var rank;
            $("#leaderrow").html("");
            high_scores.forEach((high_score, index) => {
              // high_score.initials
              // high_score.score
              rank = index + 1;
              $("#leaderrow").append("<li><span class='leaderinitial rank-" + rank + "'></span> .............<span class='leaderscore rank-" + rank + "'></span></li>");
              $("#leaderrow .leaderinitial.rank-" + rank).text(high_score.initials);
              $("#leaderrow .leaderscore.rank-" + rank).text(high_score.score);

            });


              // high_score => function(console.lo))
              // $("#leaderrow").innerHTML("");
            return response;
          }
        });
      }

      $(document).ready(function () {

        $(".initialcontainer").hide();


        var is_new_game_request_in_progress = false;
        var new_game_promises, web_socket_connect_resolve, web_socket_connect_reject;
        $(".new-game").click(function(){
          if (is_new_game_request_in_progress) {
            return;
          }

          is_new_game_request_in_progress = true;
          new_game_promises = [];

          new_game_promises.push($.post({
            url: "/api/enqueue_game",
            data: JSON.stringify({
              title: 'snake',
              difficulty: $("#difficulty").val()
            })
          }));

          new_game_promises.push(new Promise(function(resolve, reject) {
            web_socket_connect_resolve = resolve;
            web_socket_connect_reject = reject;
          }));

          var new_uri;
          if (window.location.protocol === "https:") {
            new_uri = "wss:";
          } else {
            new_uri = "ws:";
          }
          new_uri += "//" + window.location.hostname + ":8765/";

          // prevent memory leaks from the previous games' listeners hanging around?
          if (web_socket) {
            web_socket.close(1000, "closing because new game");
            web_socket.removeEventListener('open', onWebSocketOpen);
            web_socket.removeEventListener('close', onWebSocketClose);
            web_socket.removeEventListener('error', onWebSocketError);
            web_socket.removeEventListener('message', onWebSocketMessage);
          }

          var pending_web_socket = new WebSocket(new_uri);
          pending_web_socket.addEventListener('open', onWebSocketOpen);
          pending_web_socket.addEventListener('close', onWebSocketClose);
          pending_web_socket.addEventListener('error', onWebSocketError);
          pending_web_socket.addEventListener('message', onWebSocketMessage);

          Promise.all(new_game_promises).then(
            function(args) {
              // Send the playlist_video_id we expect to the websocket to be connected to on the server for validation.
              pending_web_socket.send(JSON.stringify({
                playlist_video_id: args[0].playlist_video_id,
              }));
              web_socket = pending_web_socket;
              is_new_game_request_in_progress = false;
            },
            function(err) {
              console.log("Error waiting for new game promises.", err);
              is_new_game_request_in_progress = false;
            }
          );
        });

        function onWebSocketOpen(event) {
          console.log("WebSocket is open.");
          web_socket_connect_resolve("websocket opened");
        }
        function onWebSocketError(event) {
          console.log("WebSocket errored.");
          web_socket_connect_reject("websocket errored");
        }
        function onWebSocketClose(event) {
          console.log("WebSocket is closed.");
        }
        function onWebSocketMessage(event) {
          var message = JSON.parse(event.data);
          if(message.message_type == "high_score") {
            last_high_score_id = message.score_id;
            $(".initialcontainer").show();
            $("#init1").focus();
          }
        }

        $(".quad").click(function() {
          if (!web_socket) {
            return;
          }
          var direction = $(this).data("direction");
          web_socket.send(direction);
          $(".button").css("background-image", "url('/assets/snake/snake.png')");
          $(".button[data-direction='" + direction + "']").css("background-image", "url('/assets/snake/snake-active.png')");
        });


        //Keyboard input
        $(document).keydown(function(e) {
          if (!web_socket || web_socket.readyState != WebSocket.OPEN) {
            return;
          }
          var keyinput = e.keyCode;
          var direction;
          //Arrow key input
          if (keyinput == 38) { direction = 1; }
          if (keyinput == 40) { direction = 2; }
          if (keyinput == 37) { direction = 3; }
          if (keyinput == 39) { direction = 4; }


          //WASD input

          if (keyinput == 87) { direction = 1; }
          if (keyinput == 83) { direction = 2; }
          if (keyinput == 65) { direction = 3; }
          if (keyinput == 68) { direction = 4; }


          if(direction) {
            web_socket.send(direction);

            //change to pre-loaded images
            $(".button").css("background-image", "url('/assets/snake/snake.png')");
            $(".button[data-direction='" + direction + "']").css("background-image", "url('/assets/snake/snake-active.png')");
          }
        });

        //Menu button for mobile
        $(".menubutton").click(function() {
          $(".menu").slideToggle("fast");
        });

        //Dropdown menu toggle
        $(".dropdown").click(function() {
          $(this).next("ul").toggle("fast","swing");
        });

        //Show/hide leaderboard
        $("#leader").click(function() {
          $(".leaderboard").fadeIn();
          GetHighScores();
        });
        $(document).mouseup(function (e){
          var container = $(".leaderboard");
          if (!container.is(e.target) && container.has(e.target).length === 0){
          container.fadeOut();
        }
        });

        //Lower difficulty if mobile
        var isTouchDevice = 'ontouchstart' in document.documentElement;
        if ( isTouchDevice ) {
        // do mobile handling
          var difficulty = $('#difficulty');
          difficulty.val('3');

          $(".new-game").click(function() {
            $(".menu").hide();
          });

        }

        $('#difficulty').on('input', function() {
          localStorage.setItem('difficulty', this.value);
          document.getElementById('difficultyval').innerHTML = this.value;
        });

        var saved_difficulty = localStorage.getItem('difficulty');
        if (saved_difficulty !== null && parseInt(saved_difficulty) == saved_difficulty && saved_difficulty > 0 && saved_difficulty < 10) {
          $('#difficulty').val(saved_difficulty);
        }

        document.getElementById('difficultyval').innerHTML = document.getElementById('difficulty').value;


      });
    </script>

    <span class="menubutton">Menu</span>

    <nav class="menu">
      <ul>
        <li><a class="new-game">New Game</a></li>
        <li>
          <a class="dropdown">Settings</a>
          <ul>
            <li><label>Difficulty</label>
              <input type="range" min="1" max="9" value="7" class="slider" id="difficulty"><span id="difficultyval"></span>
            </li>
          </ul>
        </li>
        <li><a id="leader">Hi-Score</a></li>
        <li><a href="http://pifi.club">Pi-Fi</a></li>
      </ul>
    </nav>

  </head>
  <body>

    <div class="quad topq" data-direction="1"></div>
    <div class="quad leftq" data-direction="3"></div>
    <div class="quad rightq" data-direction="4"></div>
    <div class="quad bottomq" data-direction="2"></div>

    <div class="leaderboard">
      <ol id="leaderrow">
        Loading...
      </ol>
    </div>


        <div class="initialcontainer">

      <div id="init1" class="initwrap" tabindex="1">
        <span class="arrowup"></span>
        <div class="initialinput">
          <div class="initiallist"></div>
        </div>
        <span class="arrowdown"></span>
      </div>

      <div id="init2" class="initwrap" tabindex="2">
        <span class="arrowup"></span>
        <div class="initialinput">
          <div class="initiallist"></div>
        </div>
        <span class="arrowdown"></span>
      </div>

      <div id="init3" class="initwrap" tabindex="3">
        <span class="arrowup"></span>
        <div class="initialinput">
          <div class="initiallist"></div>
        </div>
        <span class="arrowdown"></span>
      </div>

      <div id="initials-submit" class="enterinit" tabindex="4">
        Enter
      </div>

    </div>


    <div class="wrapper">
      <div class="button up" data-direction="1"></div>
      <div class="lrwrapper">
        <div class="button left" data-direction="3"></div>
        <div class="spacer"></div>
        <div class="button right" data-direction="4"></div>
      </div>
      <div class="button down" data-direction="2"></div>

    </div>


    <script type="text/javascript" src="/assets/snake/highscore-initials.js"></script>
  </body>

</html>


